# Changelog

## v0.9.0 (Core Flight Feel: inertial manual flight)
- Ручной полёт переведён на "телесную" модель:
  - скорость с инерцией (accel/brake + drag) вместо мгновенного 0↔speed
  - поворот через угловую скорость `yaw_rate` (accel/decel + drag) вместо мгновенного yaw
  - ограничение манёвра на скорости (yaw-rate caps зависят от скорости)
  - лёгкий крен камеры (bank) в поворотах
- CLI: добавлены параметры тюнинга полёта (`--accel`, `--brake`, `--drag`, `--yaw-*`, `--bank-*`).
- Debug overlay: выводит `v`, `yaw_rate`, `bank` для ручного режима.
- Документация: обновлены README, tech-доки и PM-доки под текущую реализацию.
- Hotfix packaging: добавлен пакет `flight.util` и модуль `flight.util.math` для корректного импорта.

### Как проверить
1) `poetry install`
2) `poetry run flight --debug`
3) Проверьте:
   - нажмите/отпустите ↑ — скорость изменяется плавно (видно `v=` в HUD)
   - коротко нажмите ←/→ — поворот "докатится" и плавно затухает (видно `yaw_rate=`)
   - на высокой скорости поворот менее резкий
   - в поворотах камера слегка кренится (видно `bank=`)
4) `poetry run flight --auto` — автополёт работает как раньше.

## v0.8.2 (Fix: left/right turn inversion)
- Исправлена инверсия поворота в ручном режиме: теперь **← поворачивает влево, → поворачивает вправо**.
  - Причина: знак поворота в `CameraFlight` был применён в неверном направлении относительно текущей системы координат/матрицы вида.
- Метаданные/документация: версия обновлена до `0.8.2`.

### Как проверить
1) `poetry install`
2) `poetry run flight` — удерживайте ←/→ и убедитесь, что поворот соответствует стрелкам.
3) (опционально) `poetry run flight --auto` — автополёт вперёд работает как раньше.

## v0.8.1 (Controls: arrow keys + auto-flight, fix turn direction)
- Добавлено ручное управление полётом стрелками:
  - ↑ вперёд, ↓ назад, ← поворот влево, → поворот вправо.
- Добавлен режим автополёта `--auto` (движение вперёд как в ранних версиях, без ручного управления).
- Исправлено направление поворота: **→ поворачивает вправо, ← поворачивает влево**.
- CLI: добавлены параметры `--auto`, `--turn-rate`.
- Документация: обновлены README и `docs/tech/build_run.md` под новые режимы управления.
- Метаданные: версия в `pyproject.toml` обновлена до `0.8.1`.

### Как проверить
1) `poetry install`
2) Ручной режим: `poetry run flight` — проверьте, что ←/→ поворачивают в правильные стороны.
3) Автополёт: `poetry run flight --auto` — камера летит вперёд без ручного управления.

## v0.7.0 (Forests: 3D trees, Variant C)
- Добавлены леса в виде **реальных 3D-деревьев** через инстансинг.
- Размещение деревьев детерминированное: на основе биом-маски (moisture) + ограничений по высоте, уклону и воде.
- Для производительности деревья по умолчанию включены только в **near** LOD-кольце (far без деревьев).
- CLI: `--trees/--no-trees`, `--tree-density`.
- Документация: добавлен `docs/tech/forests.md`, обновлены README и `docs/tech/world_generation.md`.
- Синхронизация метаданных и документации с кодом:
  - `pyproject.toml` обновлён до версии `0.7.0`.
  - help-текст `--lod` приведён к фактическому дефолту (LOD выключен).
  - `docs/tech/build_run.md` обновлён под текущий набор CLI-параметров.

### Как проверить
1) `poetry install`
2) `poetry run flight --debug`
3) Проверьте:
   - на равнинных и холмистых участках периодически появляются группы деревьев
   - деревья отсутствуют на воде и на очень крутых склонах/скалах
   - на снежных пиках деревьев мало или нет
   - опционально: `poetry run flight --no-trees` отключает леса, остальное не меняется

## v0.6 (Rugged terrain + peaks + carved rivers)
- Рельеф: добавлен `crinkle` слой (частые перепады высоты без "шумовой каши") + усилены средние частоты для более холмистой формы.
- Горы: заменены длинные хребты на **пики** ("peak fields"), иногда встречаются группами по 2–3; высокие снежные плато оставлены редкими.
- Реки: реки теперь **врезаются в рельеф** (carving) и текут в ущельях; частота/площадь озёр сохранена (маска озёр вычисляется до carving).

### Как проверить
1) `poetry install`
2) `poetry run flight --debug`
3) Проверьте:
   - поверхность заметно менее гладкая, часто меняется по высоте
   - в кадре периодически встречаются острые высокие пики (иногда группами), снег появляется на вершинах
   - реки выглядят как русла в долинах/ущельях (вода ниже берегов), при этом озёра по частоте остаются прежними

## v0.5.2 (Fix: water reflection + more relief)
- Вода: добавлена процедурная рябь в шейдере + Fresnel и псевдо-отражение неба (без отдельного reflection pass).
- Ландшафт: добавлен слой «hills» (больше холмов) и редкая горная маска с высокими пиками.
- Снег: снежные вершины по высоте + уклону (на крутых склонах меньше).

### Как проверить
1) `poetry install`
2) `poetry run flight --debug`
3) Проверьте:
   - вода отражает небо при малых углах (Fresnel), рябь слегка «ломает» отражение
   - рельеф чаще «катится» холмами, иногда попадаются высокие горы
   - на высоких вершинах появляется снег

## v0.3.0 (Final, Variant A: stability baseline)
- Убраны источники мерцания (процедурные контуры/noise/мелкие детали в шейдере)
- Зафиксирован базовый шейдер: palette-by-height + Lambert + fog (forward)
- LOD по умолчанию выключен (можно включить флагом, но это вне стабильного baseline)

### v0.3 update: разнообразный ландшафт + вода
- Генерация высот стала более разнообразной: domain-warp + macro layer (низкочастотно, без shimmer)
- Добавлены реки и озёра:
  - озёра: плоская поверхность на уровне `water_level`
  - реки: редкие источники + downhill trace, визуализация через маску воды
- Вершинный формат расширен: `pos(3) + norm(3) + water(1)`

### Как проверить
1) `poetry install`
2) `poetry run flight --debug`
3) Убедитесь, что видны синие области (озёра) и синеватые линии (реки), а рельеф заметно отличается от равномерного шума.

# CHANGELOG (v0.1.0)

## Hotfix: macOS OpenGL context request
- Добавлен запрос OpenGL 3.3 Core Profile через pygame GL attributes
- Добавлен fallback выбора GLSL версии (330/150) по версии контекста


## Что сделано
- Каркас приложения (pygame + ModernGL), запуск через `poetry run flight`
- Процедурная гористая поверхность на основе OpenSimplex (fBm)
- Бесконечный мир через чанки (коридор 5x8) с подгрузкой по мере полёта
- Фоновая генерация чанков (thread + очереди), дозированная загрузка в GPU
- Камера на "рельсах": движение вперёд, высота следует рельефу со сглаживанием
- Простое освещение (Lambert) + туман по дальности, цвет по высоте
- Документация для PM и технических специалистов + база знаний

## Как проверить
1) `poetry install`
2) `poetry run flight`
3) Наблюдайте непрерывный полёт вперёд без поворотов и без остановки мира.
4) Закройте окно или нажмите `Esc`.

## Изменения в интерфейсе/конфиге
- Добавлен CLI `flight` и параметры `--seed`, `--speed`, `--height-offset`, `--wireframe`

## Hotfix: terrain not visible
- Исправлен порядок индексов (winding) для корректной видимости при backface culling
- Отключён CULL_FACE по умолчанию (можно включить позже после проверки)

## Last fix: запуск + диагностика
- Исправлен debug-fix (World.update_requests не теряется)
- Добавлен debug triangle и периодический лог (z/y/chunks)
- Уточнён запрос OpenGL контекста под macOS

## Variant B (на основе текущей ветки)
- Warmup на старте (предзагрузка чанков)
- Флаг `--debug` включает HUD и логи
- Ускоренная подгрузка чанков первые 2 секунды

## v0.2
- Добавлены контурные линии по высоте (упрощают восприятие рельефа и движения)
- Добавлены CLI параметры: --chunk-res, --chunk-size, --fog-start, --fog-end
- Добавлен документ: docs/tech/apply_archives.md (как применять архивы)
- HUD в --debug показывает параметры мира и тумана

## v0.2.1
- Туман: изменён расчёт на более заметный (smoothstep по forward distance)
- Ускорена генерация чанков: добавлен векторизованный быстрый шум и height_grid

## v0.2.2 (закрытие v0.2)
- Добавлен sky-рендер (градиент + солнце как ориентир)
- Добавлен `--noise fast|simplex`
- Ускорена генерация чанков (векторизованная сетка высот)
- Туман сделан заметнее (forward smoothstep)

## v0.3.0 (A: FPS first)
- LOD: near/high + far/low, far обновляется реже
- Skirts по краям чанков
- Адаптивный upload/frame по target FPS
- CLI: --lod/--no-lod, --target-fps

## v0.3.5.1
- Fix: добавлен uniform u_chunk_fade и переменная cf в фрагментном шейдере.
