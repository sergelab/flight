# Модель ручного полёта (v0.9)

Документ описывает **текущую** модель управления ручным полётом (core flight feel).

- Управление: ↑/↓ — газ (throttle), ←/→ — поворот (turn), Esc — выход.
- Режим `--auto` отключает ручное управление и включает автополёт.

## Идея

Ручной режим строится вокруг "телесного" ощущения:
- скорость меняется через **ускорение/торможение**, а не мгновенно;
- поворот происходит через **угловую скорость** (`yaw_rate`) с инерцией;
- на высокой скорости манёвр ограничен (yaw-rate caps зависят от скорости);
- камера слегка **кренится** в повороте (bank).
- цифровой ввод стрелками **сглаживается**, чтобы ощущалась масса;
- для усиления ощущения веса камера имеет небольшой **лаг по yaw** и
  лёгкий **pitch** при разгоне/торможении.

## Состояния

Внутри `CameraFlight` поддерживаются состояния:
- `speed` — текущая скорость вдоль направления взгляда (units/sec)
- `yaw_rate` — текущая угловая скорость поворота (rad/sec)
- `bank` — текущий крен камеры (radians)

Дополнительно для восприятия "веса":
- `_throttle`, `_turn` — сглаженный ввод (-1..1)
- `_cam_yaw` — yaw для вида (слегка отстаёт от физического yaw)
- `_pitch` — визуальный pitch, зависящий от продольного ускорения

Положение `(x, y, z)` и `yaw` — как и раньше.

## Линейная динамика (скорость)

Ввод `throttle` (↑/↓) задаёт **целевую** скорость:

- `speed_target = throttle * max_speed`

`speed` догоняет `speed_target` с ограничением по ускорению/торможению:
- если нужно увеличить модуль скорости — используется `accel`
- иначе — `brake`

После этого применяется экспоненциальный drag:
- `speed *= exp(-drag * dt)`

Идея: отпускание газа даёт "накат".

## Угловая динамика (поворот)

Ввод `turn` (←/→) задаёт **целевую** угловую скорость:

- `yaw_rate_target = -turn * yaw_rate_cap(speed)`

Знак инвертирован, чтобы `→` соответствовала повороту вправо в текущей системе координат.

Ограничение манёвра на скорости:

- `yaw_rate_cap` интерполируется между `yaw_rate_slow` (на малой скорости)
  и `yaw_rate_fast` (на высокой скорости).

`yaw_rate` догоняет `yaw_rate_target` с ограничением по `yaw_accel/yaw_decel` и экспоненциальным `yaw_drag`.

## Реакция камеры (bank)

Крен в повороте вычисляется от `yaw_rate` и нормированной скорости. Знак инвертирован, чтобы крен визуально наклонял камеру в сторону воспринимаемого поворота:

- `bank_target = clamp(-yaw_rate * bank_gain * speed_norm, -bank_max, bank_max)`

`bank` сглаживается экспоненциально (`bank_smooth`). В матрице вида `up` вращается вокруг `forward` на угол `bank`.

## Сглаживание ввода и лаг вида

Поскольку ввод стрелками дискретный (on/off), перед расчётом цели используется экспоненциальное сглаживание:

- `_throttle = exp_smooth(_throttle, throttle, input_smooth, dt)`
- `_turn = exp_smooth(_turn, turn, input_smooth, dt)`

Для усиления ощущения "массы" вид использует слегка отстающий yaw:

- `_cam_yaw = exp_smooth_angle(_cam_yaw, yaw, cam_yaw_smooth, dt)`

## Визуальный pitch на продольном ускорении

Чтобы разгон/торможение ощущались не только по цифрам скорости, добавляется тонкий pitch-эффект:

- `long_accel = (speed - prev_speed) / dt`
- `pitch_target = clamp(-long_accel * pitch_gain, -pitch_max, pitch_max)`
- `_pitch = exp_smooth(_pitch, pitch_target, pitch_smooth, dt)`

Pitch применяется как поправка к `look_down` (разгон → слегка вверх, торможение → слегка вниз).

## Параметры CLI

Полный список — в `/docs/tech/build_run.md`.

Ключевые параметры:
- `--speed` — max speed
- `--accel`, `--brake`, `--drag`
- `--yaw-rate-slow`, `--yaw-rate-fast`, `--yaw-accel`, `--yaw-decel`, `--yaw-drag`
- `--bank-gain`, `--bank-max`, `--bank-smooth`
- `--input-smooth` — сглаживание цифрового ввода (меньше = тяжелее)
- `--cam-yaw-smooth` — лаг yaw камеры (меньше = тяжелее)
- `--pitch-gain`, `--pitch-max`, `--pitch-smooth` — визуальный pitch от разгона/торможения

`--turn-rate` — legacy (v0.8): используется только как совместимость/fallback.
