# Генерация мира

## Чанки
- Мир разбит на чанки в XZ.
- Параметры:
  - `CHUNK_WORLD_SIZE` — размер чанка в мировых единицах
  - `CHUNK_RES` — количество вершин по стороне

## Высота
`height(x,z)` вычисляется детерминированно по `seed` на основе fBm (FastValueNoise или опционально OpenSimplex).

Начиная с v0.3 генерация рельефа стала более разнообразной за счёт:
- **domain warp** (низкочастотное искажение координат) — добавляет "изломы" форм без мелкого шума
- **macro layer** (ещё одна низкая частота) — меняет крупный рисунок гор/долин

Важно: все добавления остаются **низкочастотными** (Variant A), чтобы не создавать shimmer на движении камеры.

## Вода (v0.3)
Добавлены **озёра и реки**:
- **озёра**: все вершины ниже `water_level` поднимаются до уровня воды (плоская поверхность)
- **реки**: редкие "истоки" выбираются на грубой сетке, дальше выполняется лёгкий **downhill trace** (поиск более низкой высоты в 8 направлениях)

На GPU в вершины дополнительно передаётся `water` маска:
- `0.0` — суша
- `0..~0.75` — река (интенсивность)
- `~1.0` — озеро

## Вода (v0.6): реки в ущельях
Начиная с v0.6 реки не только окрашиваются, но и **врезаются в рельеф**:
- трасса реки строится тем же лёгким "downhill trace"
- вдоль русла применяется **carving**: локальное понижение высоты с V-профилем (по Gaussian маске)

Важно: маска озёр вычисляется **до** carving, поэтому частота/площадь озёр не "расползается" из‑за углубления русел.

Параметры carving доступны в `HeightProvider` (см. `flight/world/height.py`):
- `river_carve_width`, `river_carve_depth`, `river_carve_power`

## Швы
Чтобы не было швов между чанками:
- высота вычисляется в мировых координатах (x,z), а не в локальных.


## v0.2.1: производительность
Введён быстрый векторизованный value-noise (numpy), позволяющий считать высоты на сетке чанка без двойных Python-циклов.


## v0.3: LOD (FPS first)
Реализованы 2 кольца чанков: near (высокая детализация) и far (пониженная). Far обновляется реже и загружается с меньшим бюджетом.
Добавлены skirts по краям чанков для уменьшения щелей.

## v0.3 note
В v0.3 упор на стабильность: визуальные детали делаются не через процедурные контуры в шейдере, а через крупную форму рельефа + освещение + fog.

## v0.6: более "неровный" рельеф + пики + редкие снежные плато
В v0.6 цель — убрать ощущение "гладкой равнины" и сделать горы именно **пиками**, а не длинными хребтами:
- `crinkle` слой: высокочастотный шум с небольшой амплитудой (частые локальные перепады высот без "мусора")
- `peak fields`: пики генерируются на грубой сетке как локальные поля (радиальный спад + ridged‑деталь), иногда встречаются небольшими группами
- редкие высокие плато: террасирование применяется только в редких регионах и только на большой высоте (плато задуманы как снежные)
